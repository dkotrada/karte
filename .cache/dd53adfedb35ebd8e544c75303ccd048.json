{"dependencies":[{"name":"sliced","loc":{"line":7,"column":20}},{"name":"assert","loc":{"line":8,"column":21}},{"name":"util","loc":{"line":9,"column":19}},{"name":"./utils","loc":{"line":10,"column":20}},{"name":"debug","loc":{"line":11,"column":20}},{"name":"./permissions","loc":{"line":2977,"column":28}},{"name":"./env","loc":{"line":3034,"column":20}},{"name":"./collection","loc":{"line":3035,"column":27}},{"name":"./collection/collection","loc":{"line":3036,"column":31}},{"name":"bluebird","loc":{"line":3037,"column":24}}],"generated":{"js":"\"use strict\";var t=require(\"sliced\"),e=require(\"assert\"),i=require(\"util\"),n=require(\"./utils\"),o=require(\"debug\")(\"mquery\");function r(t,e){if(!(this instanceof r))return new r(t,e);var i=this.constructor.prototype;this.op=i.op||void 0,this.options={},this.setOptions(i.options),this._conditions=i._conditions?n.clone(i._conditions,{retainKeyOrder:this.options.retainKeyOrder}):{},this._fields=i._fields?n.clone(i._fields,{retainKeyOrder:this.options.retainKeyOrder}):void 0,this._update=i._update?n.clone(i._update,{retainKeyOrder:this.options.retainKeyOrder}):void 0,this._path=i._path||void 0,this._distinct=i._distinct||void 0,this._collection=i._collection||void 0,this._traceFunction=i._traceFunction||void 0,e&&this.setOptions(e),t&&(t.find&&t.remove&&t.update?this.collection(t):this.find(t))}var s=\"$geoWithin\";function a(t,e,i){if(Array.isArray(t.sort))throw new TypeError(\"Can't mix sort syntaxes. Use either array or object:\\n- `.sort([['field', 1], ['test', -1]])`\\n- `.sort({ field: 1, test: -1 })`\");if(i&&i.$meta){(r=t.sort||(t.sort={}))[e]={$meta:i.$meta}}else{var o=String(i||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(o))throw n.isArray(i)&&(i=\"[\"+i+\"]\"),new TypeError(\"Invalid sort value: {\"+e+\": \"+i+\" }\");var r=t.sort||(t.sort={}),s=i.toString().replace(\"asc\",\"1\").replace(\"ascending\",\"1\").replace(\"desc\",\"-1\").replace(\"descending\",\"-1\");r[e]=parseInt(s,10)}}function c(t,e,i){if(t.sort=t.sort||[],!Array.isArray(t.sort))throw new TypeError(\"Can't mix sort syntaxes. Use either array or object:\\n- `.sort([['field', 1], ['test', -1]])`\\n- `.sort({ field: 1, test: -1 })`\");i.toString().replace(\"asc\",\"1\").replace(\"ascending\",\"1\").replace(\"desc\",\"-1\").replace(\"descending\",\"-1\");t.sort.push([e,i])}function h(t,e){if(t.sort=t.sort||new Map,!(t.sort instanceof Map))throw new TypeError(\"Can't mix sort syntaxes. Use either array or object or map consistently\");e.forEach(function(e,i){var n=e.toString().replace(\"asc\",\"1\").replace(\"ascending\",\"1\").replace(\"desc\",\"-1\").replace(\"descending\",\"-1\");t.sort.set(i,n)})}function p(t,e,i,s,a,c,h){if(t.op=e,r.canMerge(i)&&t.merge(i),s&&t._mergeUpdate(s),n.isObject(a)&&t.setOptions(a),!c&&!h)return t;if(!t._update||!t.options.overwrite&&0===n.keys(t._update).length)return h&&n.soon(h.bind(null,null,0)),t;a=t._optionsForExec(),h||(a.safe=!1);i=t._conditions;return s=t._updateForExec(),o(\"update\",t._collection.collectionName,i,s,a),h=t._wrapCallback(e,h,{conditions:i,doc:s,options:a}),t._collection[e](i,s,a,n.tick(h)),t}Object.defineProperty(r,\"use$geoWithin\",{get:function(){return\"$geoWithin\"==s},set:function(t){s=!0===t?\"$geoWithin\":\"$within\"}}),r.prototype.toConstructor=function(){function t(e,i){if(!(this instanceof t))return new t(e,i);r.call(this,e,i)}n.inherits(t,r);var e=t.prototype;return e.options={},e.setOptions(this.options),e.op=this.op,e._conditions=n.clone(this._conditions,{retainKeyOrder:this.options.retainKeyOrder}),e._fields=n.clone(this._fields,{retainKeyOrder:this.options.retainKeyOrder}),e._update=n.clone(this._update,{retainKeyOrder:this.options.retainKeyOrder}),e._path=this._path,e._distinct=this._distinct,e._collection=this._collection,e._traceFunction=this._traceFunction,t},r.prototype.setOptions=function(t){if(!t||!n.isObject(t))return this;for(var e,i=n.keys(t),o=0;o<i.length;++o)if(\"function\"==typeof this[e=i[o]]){var r=n.isArray(t[e])?t[e]:[t[e]];this[e].apply(this,r)}else this.options[e]=t[e];return this},r.prototype.collection=function(t){return this._collection=new r.Collection(t),this},r.prototype.$where=function(t){return this._conditions.$where=t,this},r.prototype.where=function(){if(!arguments.length)return this;this.op||(this.op=\"find\");var t=typeof arguments[0];if(\"string\"==t)return this._path=arguments[0],2===arguments.length&&(this._conditions[this._path]=arguments[1]),this;if(\"object\"==t&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw new TypeError(\"path must be a string or object\")},r.prototype.equals=function(t){this._ensurePath(\"equals\");var e=this._path;return this._conditions[e]=t,this},r.prototype.eq=function(t){this._ensurePath(\"eq\");var e=this._path;return this._conditions[e]=t,this},r.prototype.or=function(t){var e=this._conditions.$or||(this._conditions.$or=[]);return n.isArray(t)||(t=[t]),e.push.apply(e,t),this},r.prototype.nor=function(t){var e=this._conditions.$nor||(this._conditions.$nor=[]);return n.isArray(t)||(t=[t]),e.push.apply(e,t),this},r.prototype.and=function(t){var e=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(t)||(t=[t]),e.push.apply(e,t),this},\"gt gte lt lte ne in nin all regex size maxDistance minDistance\".split(\" \").forEach(function(t){r.prototype[t]=function(){var e,i;return 1===arguments.length?(this._ensurePath(t),i=arguments[0],e=this._path):(i=arguments[1],e=arguments[0]),(null===this._conditions[e]||\"object\"==typeof this._conditions[e]?this._conditions[e]:this._conditions[e]={})[\"$\"+t]=i,this}}),r.prototype.mod=function(){var e,i;return 1===arguments.length?(this._ensurePath(\"mod\"),e=arguments[0],i=this._path):2!==arguments.length||n.isArray(arguments[1])?3===arguments.length?(e=t(arguments,1),i=arguments[0]):(e=arguments[1],i=arguments[0]):(this._ensurePath(\"mod\"),e=t(arguments),i=this._path),(this._conditions[i]||(this._conditions[i]={})).$mod=e,this},r.prototype.exists=function(){var t,e;return 0===arguments.length?(this._ensurePath(\"exists\"),t=this._path,e=!0):1===arguments.length?\"boolean\"==typeof arguments[0]?(this._ensurePath(\"exists\"),t=this._path,e=arguments[0]):(t=arguments[0],e=!0):2===arguments.length&&(t=arguments[0],e=arguments[1]),(this._conditions[t]||(this._conditions[t]={})).$exists=e,this},r.prototype.elemMatch=function(){if(null==arguments[0])throw new TypeError(\"Invalid argument\");var t,e,i;if(\"function\"==typeof arguments[0])this._ensurePath(\"elemMatch\"),e=this._path,t=arguments[0];else if(n.isObject(arguments[0]))this._ensurePath(\"elemMatch\"),e=this._path,i=arguments[0];else if(\"function\"==typeof arguments[1])e=arguments[0],t=arguments[1];else{if(!arguments[1]||!n.isObject(arguments[1]))throw new TypeError(\"Invalid argument\");e=arguments[0],i=arguments[1]}return t&&(t(i=new r),i=i._conditions),(this._conditions[e]||(this._conditions[e]={})).$elemMatch=i,this},r.prototype.within=function(){if(this._ensurePath(\"within\"),this._geoComparison=s,0===arguments.length)return this;if(2===arguments.length)return this.box.apply(this,arguments);if(2<arguments.length)return this.polygon.apply(this,arguments);var t=arguments[0];if(!t)throw new TypeError(\"Invalid argument\");if(t.center)return this.circle(t);if(t.box)return this.box.apply(this,t.box);if(t.polygon)return this.polygon.apply(this,t.polygon);if(t.type&&t.coordinates)return this.geometry(t);throw new TypeError(\"Invalid argument\")},r.prototype.box=function(){var t,e;if(3===arguments.length)t=arguments[0],e=[arguments[1],arguments[2]];else{if(2!==arguments.length)throw new TypeError(\"Invalid argument\");this._ensurePath(\"box\"),t=this._path,e=[arguments[0],arguments[1]]}return(this._conditions[t]||(this._conditions[t]={}))[this._geoComparison||s]={$box:e},this},r.prototype.polygon=function(){var e,i;return\"string\"==typeof arguments[0]?(i=arguments[0],e=t(arguments,1)):(this._ensurePath(\"polygon\"),i=this._path,e=t(arguments)),(this._conditions[i]||(this._conditions[i]={}))[this._geoComparison||s]={$polygon:e},this},r.prototype.circle=function(){var t,e;if(1===arguments.length)this._ensurePath(\"circle\"),t=this._path,e=arguments[0];else{if(2!==arguments.length)throw new TypeError(\"Invalid argument\");t=arguments[0],e=arguments[1]}if(!(\"radius\"in e&&e.center))throw new Error(\"center and radius are required\");var i=this._conditions[t]||(this._conditions[t]={}),n=e.spherical?\"$centerSphere\":\"$center\",o=this._geoComparison||s;return i[o]={},i[o][n]=[e.center,e.radius],\"unique\"in e&&(i[o].$uniqueDocs=!!e.unique),this},r.prototype.near=function(){var t,e;if(this._geoComparison=\"$near\",0===arguments.length)return this;if(1===arguments.length)this._ensurePath(\"near\"),t=this._path,e=arguments[0];else{if(2!==arguments.length)throw new TypeError(\"Invalid argument\");t=arguments[0],e=arguments[1]}if(!e.center)throw new Error(\"center is required\");var n=this._conditions[t]||(this._conditions[t]={}),o=e.spherical?\"$nearSphere\":\"$near\";if(Array.isArray(e.center)){n[o]=e.center;var r=\"maxDistance\"in e?e.maxDistance:null;null!=r&&(n.$maxDistance=r),null!=e.minDistance&&(n.$minDistance=e.minDistance)}else{if(\"Point\"!=e.center.type||!Array.isArray(e.center.coordinates))throw new Error(i.format(\"Invalid GeoJSON specified for %s\",o));n[o]={$geometry:e.center},\"maxDistance\"in e&&(n[o].$maxDistance=e.maxDistance),\"minDistance\"in e&&(n[o].$minDistance=e.minDistance)}return this},r.prototype.intersects=function(){if(this._ensurePath(\"intersects\"),this._geoComparison=\"$geoIntersects\",0===arguments.length)return this;var t=arguments[0];if(null!=t&&t.type&&t.coordinates)return this.geometry(t);throw new TypeError(\"Invalid argument\")},r.prototype.geometry=function(){if(\"$within\"!=this._geoComparison&&\"$geoWithin\"!=this._geoComparison&&\"$near\"!=this._geoComparison&&\"$geoIntersects\"!=this._geoComparison)throw new Error(\"geometry() must come after `within()`, `intersects()`, or `near()\");var t,e;if(1!==arguments.length)throw new TypeError(\"Invalid argument\");if(this._ensurePath(\"geometry\"),e=this._path,!(t=arguments[0]).type||!Array.isArray(t.coordinates))throw new TypeError(\"Invalid argument\");return(this._conditions[e]||(this._conditions[e]={}))[this._geoComparison]={$geometry:t},this},r.prototype.select=function(){var t=arguments[0];if(!t)return this;if(1!==arguments.length)throw new Error(\"Invalid select: select only takes 1 argument\");this._validate(\"select\");var e=this._fields||(this._fields={}),i=typeof t;if((\"string\"==i||n.isArgumentsObject(t))&&\"number\"==typeof t.length||Array.isArray(t)){\"string\"==i&&(t=t.split(/\\s+/));for(var o=0,r=t.length;o<r;++o){var s=t[o];if(s){var a=\"-\"==s[0]?0:1;0===a&&(s=s.substring(1)),e[s]=a}}return this}if(n.isObject(t)){var c=n.keys(t);for(o=0;o<c.length;++o)e[c[o]]=t[c[o]];return this}throw new TypeError(\"Invalid select() argument. Must be string or object.\")},r.prototype.slice=function(){if(0===arguments.length)return this;var e,i;if(this._validate(\"slice\"),1===arguments.length){var n=arguments[0];if(\"object\"==typeof n&&!Array.isArray(n)){for(var o=Object.keys(n),r=o.length,s=0;s<r;++s)this.slice(o[s],n[o[s]]);return this}this._ensurePath(\"slice\"),e=this._path,i=arguments[0]}else 2===arguments.length?\"number\"==typeof arguments[0]?(this._ensurePath(\"slice\"),e=this._path,i=t(arguments)):(e=arguments[0],i=arguments[1]):3===arguments.length&&(e=arguments[0],i=t(arguments,1));return(this._fields||(this._fields={}))[e]={$slice:i},this},r.prototype.sort=function(t){if(!t)return this;var e;this._validate(\"sort\");var i=typeof t;if(Array.isArray(t)){e=t.length;for(var o=0;o<t.length;++o){if(!Array.isArray(t[o]))throw new Error(\"Invalid sort() argument, must be array of arrays\");c(this.options,t[o][0],t[o][1])}return this}if(1===arguments.length&&\"string\"==i){e=(t=t.split(/\\s+/)).length;for(o=0;o<e;++o){if(p=t[o]){var r=\"-\"==p[0]?-1:1;-1===r&&(p=p.substring(1)),a(this.options,p,r)}}return this}if(n.isObject(t)){var s=n.keys(t);for(o=0;o<s.length;++o){var p=s[o];a(this.options,p,t[p])}return this}if(\"undefined\"!=typeof Map&&t instanceof Map)return h(this.options,t),this;throw new TypeError(\"Invalid sort() argument. Must be a string, object, or array.\")},[\"limit\",\"skip\",\"maxScan\",\"batchSize\",\"comment\"].forEach(function(t){r.prototype[t]=function(e){return this._validate(t),this.options[t]=e,this}}),r.prototype.maxTime=function(t){return this._validate(\"maxTime\"),this.options.maxTimeMS=t,this},r.prototype.snapshot=function(){return this._validate(\"snapshot\"),this.options.snapshot=!arguments.length||!!arguments[0],this},r.prototype.hint=function(){if(0===arguments.length)return this;this._validate(\"hint\");var t=arguments[0];if(n.isObject(t)){var e=this.options.hint||(this.options.hint={});for(var i in t)e[i]=t[i];return this}if(\"string\"==typeof t)return this.options.hint=t,this;throw new TypeError(\"Invalid hint. \"+t)},r.prototype.slaveOk=function(t){return this.options.slaveOk=!arguments.length||!!t,this},r.prototype.read=function(t){return arguments.length>1&&!r.prototype.read.deprecationWarningIssued&&(r.prototype.read.deprecationWarningIssued=!0),this.options.readPreference=n.readPref(t),this},r.prototype.tailable=function(){return this._validate(\"tailable\"),this.options.tailable=!arguments.length||!!arguments[0],this},r.prototype.merge=function(t){if(!t)return this;if(!r.canMerge(t))throw new TypeError(\"Invalid argument. Expected instanceof mquery or plain object\");return t instanceof r?(t._conditions&&n.merge(this._conditions,t._conditions),t._fields&&(this._fields||(this._fields={}),n.merge(this._fields,t._fields)),t.options&&(this.options||(this.options={}),n.merge(this.options,t.options)),t._update&&(this._update||(this._update={}),n.mergeClone(this._update,t._update)),t._distinct&&(this._distinct=t._distinct),this):(n.merge(this._conditions,t),this)},r.prototype.find=function(t,e){if(this.op=\"find\",\"function\"==typeof t?(e=t,t=void 0):r.canMerge(t)&&this.merge(t),!e)return this;var i=this._conditions,s=this._optionsForExec();return s.fields=this._fieldsForExec(),o(\"find\",this._collection.collectionName,i,s),e=this._wrapCallback(\"find\",e,{conditions:i,options:s}),this._collection.find(i,s,n.tick(e)),this},r.prototype.cursor=function(t){if(this.op){if(\"find\"!==this.op)throw new TypeError(\".cursor only support .find method\")}else this.find(t);var e=this._conditions,i=this._optionsForExec();return i.fields=this._fieldsForExec(),o(\"findCursor\",this._collection.collectionName,e,i),this._collection.findCursor(e,i)},r.prototype.findOne=function(t,e){if(this.op=\"findOne\",\"function\"==typeof t?(e=t,t=void 0):r.canMerge(t)&&this.merge(t),!e)return this;var i=this._conditions,s=this._optionsForExec();return s.fields=this._fieldsForExec(),o(\"findOne\",this._collection.collectionName,i,s),e=this._wrapCallback(\"findOne\",e,{conditions:i,options:s}),this._collection.findOne(i,s,n.tick(e)),this},r.prototype.count=function(t,e){if(this.op=\"count\",this._validate(),\"function\"==typeof t?(e=t,t=void 0):r.canMerge(t)&&this.merge(t),!e)return this;var i=this._conditions,s=this._optionsForExec();return o(\"count\",this._collection.collectionName,i,s),e=this._wrapCallback(\"count\",e,{conditions:i,options:s}),this._collection.count(i,s,n.tick(e)),this},r.prototype.distinct=function(t,e,i){if(this.op=\"distinct\",this._validate(),!i){switch(typeof e){case\"function\":i=e,\"string\"==typeof t&&(e=t,t=void 0);break;case\"undefined\":case\"string\":break;default:throw new TypeError(\"Invalid `field` argument. Must be string or function\")}switch(typeof t){case\"function\":i=t,t=e=void 0;break;case\"string\":e=t,t=void 0}}if(\"string\"==typeof e&&(this._distinct=e),r.canMerge(t)&&this.merge(t),!i)return this;if(!this._distinct)throw new Error(\"No value for `distinct` has been declared\");var s=this._conditions,a=this._optionsForExec();return o(\"distinct\",this._collection.collectionName,s,a),i=this._wrapCallback(\"distinct\",i,{conditions:s,options:a}),this._collection.distinct(this._distinct,s,a,n.tick(i)),this},r.prototype.update=function(t,e,i,n){var o;switch(arguments.length){case 3:\"function\"==typeof i&&(n=i,i=void 0);break;case 2:\"function\"==typeof e&&(n=e,e=t,t=void 0);break;case 1:switch(typeof t){case\"function\":n=t,t=i=e=void 0;break;case\"boolean\":o=t,t=void 0;break;default:e=t,t=i=void 0}}return p(this,\"update\",t,e,i,o,n)},r.prototype.updateMany=function(t,e,i,n){var o;switch(arguments.length){case 3:\"function\"==typeof i&&(n=i,i=void 0);break;case 2:\"function\"==typeof e&&(n=e,e=t,t=void 0);break;case 1:switch(typeof t){case\"function\":n=t,t=i=e=void 0;break;case\"boolean\":o=t,t=void 0;break;default:e=t,t=i=void 0}}return p(this,\"updateMany\",t,e,i,o,n)},r.prototype.updateOne=function(t,e,i,n){var o;switch(arguments.length){case 3:\"function\"==typeof i&&(n=i,i=void 0);break;case 2:\"function\"==typeof e&&(n=e,e=t,t=void 0);break;case 1:switch(typeof t){case\"function\":n=t,t=i=e=void 0;break;case\"boolean\":o=t,t=void 0;break;default:e=t,t=i=void 0}}return p(this,\"updateOne\",t,e,i,o,n)},r.prototype.replaceOne=function(t,e,i,n){var o;switch(arguments.length){case 3:\"function\"==typeof i&&(n=i,i=void 0);break;case 2:\"function\"==typeof e&&(n=e,e=t,t=void 0);break;case 1:switch(typeof t){case\"function\":n=t,t=i=e=void 0;break;case\"boolean\":o=t,t=void 0;break;default:e=t,t=i=void 0}}return this.setOptions({overwrite:!0}),p(this,\"replaceOne\",t,e,i,o,n)},r.prototype.remove=function(t,e){var i;if(this.op=\"remove\",\"function\"==typeof t?(e=t,t=void 0):r.canMerge(t)?this.merge(t):!0===t&&(i=t,t=void 0),!i&&!e)return this;var s=this._optionsForExec();e||(s.safe=!1);var a=this._conditions;return o(\"remove\",this._collection.collectionName,a,s),e=this._wrapCallback(\"remove\",e,{conditions:a,options:s}),this._collection.remove(a,s,n.tick(e)),this},r.prototype.deleteOne=function(t,e){var i;if(this.op=\"deleteOne\",\"function\"==typeof t?(e=t,t=void 0):r.canMerge(t)?this.merge(t):!0===t&&(i=t,t=void 0),!i&&!e)return this;var s=this._optionsForExec();e||(s.safe=!1),delete s.justOne;var a=this._conditions;return o(\"deleteOne\",this._collection.collectionName,a,s),e=this._wrapCallback(\"deleteOne\",e,{conditions:a,options:s}),this._collection.deleteOne(a,s,n.tick(e)),this},r.prototype.deleteMany=function(t,e){var i;if(this.op=\"deleteMany\",\"function\"==typeof t?(e=t,t=void 0):r.canMerge(t)?this.merge(t):!0===t&&(i=t,t=void 0),!i&&!e)return this;var s=this._optionsForExec();e||(s.safe=!1),delete s.justOne;var a=this._conditions;return o(\"deleteOne\",this._collection.collectionName,a,s),e=this._wrapCallback(\"deleteOne\",e,{conditions:a,options:s}),this._collection.deleteMany(a,s,n.tick(e)),this},r.prototype.findOneAndUpdate=function(t,e,i,n){switch(this.op=\"findOneAndUpdate\",this._validate(),arguments.length){case 3:\"function\"==typeof i&&(n=i,i={});break;case 2:\"function\"==typeof e&&(n=e,e=t,t=void 0),i=void 0;break;case 1:\"function\"==typeof t?(n=t,t=i=e=void 0):(e=t,t=i=void 0)}return r.canMerge(t)&&this.merge(t),e&&this._mergeUpdate(e),i&&this.setOptions(i),n?this._findAndModify(\"update\",n):this},r.prototype.findOneAndRemove=function(t,e,i){return this.op=\"findOneAndRemove\",this._validate(),\"function\"==typeof e?(i=e,e=void 0):\"function\"==typeof t&&(i=t,t=void 0),r.canMerge(t)&&this.merge(t),e&&this.setOptions(e),i?this._findAndModify(\"remove\",i):this},r.prototype._findAndModify=function(t,i){e.equal(\"function\",typeof i);var r,s,a=this._optionsForExec();if(\"remove\"==t)a.remove=!0;else if(\"new\"in a||(a.new=!0),\"upsert\"in a||(a.upsert=!1),!(r=this._updateForExec())){if(!a.upsert)return this.findOne(i);r={$set:{}}}(s=this._fieldsForExec())&&(a.fields=s);var c=this._conditions;return o(\"findAndModify\",this._collection.collectionName,c,r,a),i=this._wrapCallback(\"findAndModify\",i,{conditions:c,doc:r,options:a}),this._collection.findAndModify(c,r,a,n.tick(i)),this},r.prototype._wrapCallback=function(t,e,i){var n=this._traceFunction||r.traceFunction;if(n){i.collectionName=this._collection.collectionName;var o=n&&n.call(null,t,i,this),s=(new Date).getTime();return function(t,i){if(o){var n=(new Date).getTime()-s;o.call(null,t,i,n)}e&&e.apply(null,arguments)}}return e},r.prototype.setTraceFunction=function(t){return this._traceFunction=t,this},r.prototype.exec=function(t,i){switch(typeof t){case\"function\":i=t,t=null;break;case\"string\":this.op=t}e.ok(this.op,\"Missing query type: (find, update, etc)\"),\"update\"!=this.op&&\"remove\"!=this.op||i||(i=!0);var n=this;if(\"function\"!=typeof i)return new r.Promise(function(t,e){n[n.op](function(i,o){i?e(i):t(o),n=t=e=null})});this[this.op](i)},r.prototype.thunk=function(){var t=this;return function(e){t.exec(e)}},r.prototype.then=function(t,e){var i=this;return new r.Promise(function(t,e){i.exec(function(n,o){n?e(n):t(o),i=t=e=null})}).then(t,e)},r.prototype.stream=function(t){if(\"find\"!=this.op)throw new Error(\"stream() is only available for find\");var e=this._conditions,i=this._optionsForExec();return i.fields=this._fieldsForExec(),o(\"stream\",this._collection.collectionName,e,i,t),this._collection.findStream(e,i,t)},r.prototype.selected=function(){return!!(this._fields&&Object.keys(this._fields).length>0)},r.prototype.selectedInclusively=function(){if(!this._fields)return!1;var t=Object.keys(this._fields);if(0===t.length)return!1;for(var e=0;e<t.length;++e){var i=t[e];if(0===this._fields[i])return!1;if(this._fields[i]&&\"object\"==typeof this._fields[i]&&this._fields[i].$meta)return!1}return!0},r.prototype.selectedExclusively=function(){if(!this._fields)return!1;var t=Object.keys(this._fields);if(0===t.length)return!1;for(var e=0;e<t.length;++e){var i=t[e];if(0===this._fields[i])return!0}return!1},r.prototype._mergeUpdate=function(t){this._update||(this._update={}),t instanceof r?t._update&&n.mergeClone(this._update,t._update):n.mergeClone(this._update,t)},r.prototype._optionsForExec=function(){return n.clone(this.options,{retainKeyOrder:!0})},r.prototype._fieldsForExec=function(){return n.clone(this._fields,{retainKeyOrder:!0})},r.prototype._updateForExec=function(){for(var t=n.clone(this._update,{retainKeyOrder:!0}),e=n.keys(t),i=e.length,o={};i--;){var r=e[i];this.options.overwrite?o[r]=t[r]:\"$\"!==r[0]?(o.$set||(t.$set?o.$set=t.$set:o.$set={}),o.$set[r]=t[r],e.splice(i,1),~e.indexOf(\"$set\")||e.push(\"$set\")):\"$set\"===r?o.$set||(o[r]=t[r]):o[r]=t[r]}return this._compiledUpdate=o,o},r.prototype._ensurePath=function(t){if(!this._path)throw new Error(t+\"() must be used after where() when called with these arguments\")},r.permissions=require(\"./permissions\"),r._isPermitted=function(t,e){var i=r.permissions[e];return!i||!0!==i[t]},r.prototype._validate=function(t){var e,i;if(void 0===t){if(\"function\"!=typeof(i=r.permissions[this.op]))return!0;e=i(this)}else r._isPermitted(t,this.op)||(e=t);if(e)throw new Error(e+\" cannot be used with \"+this.op)},r.canMerge=function(t){return t instanceof r||n.isObject(t)},r.setGlobalTraceFunction=function(t){r.traceFunction=t},r.utils=n,r.env=require(\"./env\"),r.Collection=require(\"./collection\"),r.BaseCollection=require(\"./collection/collection\"),r.Promise=require(\"bluebird\"),module.exports=exports=r;"},"hash":"7fb80005f8038085a689a8c4dc010d54"}