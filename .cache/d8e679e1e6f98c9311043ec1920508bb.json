{"dependencies":[{"name":"./drivers","loc":{"line":5,"column":23}},{"name":"events","loc":{"line":6,"column":27}},{"name":"./virtualtype","loc":{"line":7,"column":26}},{"name":"./utils","loc":{"line":8,"column":20}},{"name":"kareem","loc":{"line":10,"column":21}},{"name":"async/each","loc":{"line":11,"column":19}},{"name":"./schematype","loc":{"line":12,"column":25}},{"name":"mpath","loc":{"line":13,"column":20}},{"name":"./schema/index","loc":{"line":1922,"column":39}},{"name":"buffer"}],"generated":{"js":"var Buffer = require(\"buffer\").Buffer;\nvar t,e=require(\"buffer\").Buffer,s=require(\"./drivers\").ReadPreference,i=require(\"events\").EventEmitter,r=require(\"./virtualtype\"),n=require(\"./utils\"),a=require(\"kareem\"),o=require(\"async/each\"),h=require(\"./schematype\"),p=require(\"mpath\"),u={aggregate:!0,count:!0,find:!0,findOne:!0,findOneAndUpdate:!0,findOneAndRemove:!0,insertMany:!0,replaceOne:!0,update:!0,updateMany:!0,updateOne:!0};function c(t,e){if(!(this instanceof c))return new c(t,e);this.obj=t,this.paths={},this.aliases={},this.subpaths={},this.virtuals={},this.singleNestedPaths={},this.nested={},this.inherits={},this.callQueue=[],this._indexes=[],this.methods={},this.statics={},this.tree={},this.query={},this.childSchemas=[],this.plugins=[],this.s={hooks:new a,kareemHooks:u},this.options=this.defaultOptions(e),t&&this.add(t);var s=t&&t._id&&n.isObject(t._id);if(!this.paths._id&&!this.options.noId&&this.options._id&&!s){var i={_id:{auto:!0}};i._id[this.options.typeKey]=c.ObjectId,this.add(i)}for(var r=0;r<this._defaultMiddleware.length;++r){var o=this._defaultMiddleware[r];this[o.kind](o.hook,!!o.isAsync,o.fn)}this.options.timestamps&&this.setupTimestamp(this.options.timestamps),l(this)}function l(t){for(var e in t.paths)if(t.paths[e].options){var s=t.paths[e].path,i=t.paths[e].options.alias;if(i){if(!(\"string\"==typeof i&&i.length>0))throw new Error(\"Invalid value for alias option on \"+s+\", got \"+i);if(t.aliases[i])throw new Error(\"Duplicate alias, alias \"+i+\" is used more than once\");t.aliases[i]=s,t.virtual(i).get(function(t){return function(){return this.get(t)}}(s)).set(function(t){return function(e){return this.set(t,e)}}(s))}}}c.prototype=Object.create(i.prototype),c.prototype.constructor=c,c.prototype.instanceOfSchema=!0,Object.defineProperty(c.prototype,\"_defaultMiddleware\",{configurable:!1,enumerable:!1,writable:!1,value:[{kind:\"pre\",hook:\"remove\",isAsync:!0,fn:function(t,e){if(this.ownerDocument)return e(),void t();var s=this.$__getAllSubdocs();if(!s.length)return e(),void t();o(s,function(t,e){t.remove({noop:!0},function(t){e(t)})},function(s){s?e(s):(t(),e())})}}]}),Object.defineProperty(c.prototype,\"childSchemas\",{configurable:!1,enumerable:!0,writable:!0}),c.prototype.obj,c.prototype.paths,c.prototype.tree,c.prototype.clone=function(){var t=new c(this.paths,this.options),e={retainKeyOrder:!0};return t.callQueue=this.callQueue.map(function(t){return t}),t.methods=n.clone(this.methods,e),t.statics=n.clone(this.statics,e),t.query=n.clone(this.query,e),t.plugins=Array.prototype.slice.call(this.plugins),t._indexes=n.clone(this._indexes,e),t.s.hooks=this.s.hooks.clone(),t},c.prototype.defaultOptions=function(t){return t&&!1===t.safe&&(t.safe={w:0}),t&&t.safe&&0===t.safe.w&&(t.versionKey=!1),this._userProvidedOptions=n.clone(t,{retainKeyOrder:!0}),(t=n.options({strict:!0,bufferCommands:!0,capped:!1,versionKey:\"__v\",discriminatorKey:\"__t\",minimize:!0,autoIndex:null,shardKey:null,read:null,validateBeforeSave:!0,noId:!1,_id:!0,noVirtualId:!1,id:!0,typeKey:\"type\",retainKeyOrder:!1},t)).read&&(t.read=s(t.read)),t},c.prototype.add=function(t,e){e=e||\"\";for(var s=Object.keys(t),i=0;i<s.length;++i){var r=s[i];if(null==t[r])throw new TypeError(\"Invalid value for schema path `\"+e+r+\"`\");if(Array.isArray(t[r])&&1===t[r].length&&null==t[r][0])throw new TypeError(\"Invalid value for schema Array path `\"+e+r+\"`\");!n.isObject(t[r])||t[r].constructor&&\"Object\"!==n.getFunctionName(t[r].constructor)||t[r][this.options.typeKey]&&(\"type\"!==this.options.typeKey||!t[r].type.type)?(e&&(this.nested[e.substr(0,e.length-1)]=!0),this.path(e+r,t[r])):Object.keys(t[r]).length?(this.nested[e+r]=!0,this.add(t[r],e+r+\".\")):(e&&(this.nested[e.substr(0,e.length-1)]=!0),this.path(e+r,t[r]))}},c.reserved=Object.create(null);var d=c.reserved;d.prototype=d.emit=d.on=d.once=d.listeners=d.removeListener=d.collection=d.db=d.errors=d.init=d.isModified=d.isNew=d.get=d.modelName=d.save=d.schema=d.toObject=d.validate=d.remove=d._pres=d._posts=1;var f={};function y(t,e){return\"boolean\"==typeof t?e:\"boolean\"==typeof t[e]?t[e]?e:null:e in t?t[e]:e}function m(t){var e,s,i,r,n,a,o=new Date,h=t.getUpdate(),p=Object.keys(h),u=t.model.schema;if(p.length&&\"$\"===p[0].charAt(0)){if(h.$push)for(e in h.$push){var c=u.path(e);h.$push[e]&&c&&c.$isMongooseDocumentArray&&c.schema.options.timestamps&&(n=c.schema.options.timestamps,i=y(n,\"createdAt\"),r=y(n,\"updatedAt\"),h.$push[e].$each?h.$push[e].$each.forEach(function(t){null!=r&&(t[r]=o),null!=i&&(t[i]=o)}):(null!=r&&(h.$push[e][r]=o),null!=i&&(h.$push[e][i]=o)))}if(h.$set)for(e in h.$set)if(a=u.path(e))if(Array.isArray(h.$set[e])&&a.$isMongooseDocumentArray){if(s=h.$set[e].length,n=u.path(e).schema.options.timestamps){i=y(n,\"createdAt\"),r=y(n,\"updatedAt\");for(var l=0;l<s;++l)null!=r&&(h.$set[e][l][r]=o),null!=i&&(h.$set[e][l][i]=o)}}else h.$set[e]&&a.$isSingleNested&&(n=u.path(e).schema.options.timestamps)&&(i=y(n,\"createdAt\"),null!=(r=y(n,\"updatedAt\"))&&(h.$set[e][r]=o),null!=i&&(h.$set[e][i]=o))}}function g(e,s){var i=s.split(/\\.(\\d+)\\.|\\.(\\d+)$/).filter(Boolean);if(i.length<2)return e.paths[i[0]];var r=e.path(i[0]),n=!1;if(!r)return r;for(var a,o=i.length-1,p=1;p<i.length;++p){if(n=!1,a=i[p],p===o&&r&&!/\\D/.test(a)){if(r.$isMongooseDocumentArray){var u=r;(r=new h(a)).cast=function(t,e,s){return u.cast(t,e,s)[0]},r.caster=u.caster,r.schema=u.schema}else r=r instanceof t.Array?r.caster:void 0;break}if(/\\D/.test(a)){if(!r||!r.schema){r=void 0;break}n=\"nested\"===r.schema.pathType(a),r=r.schema.path(a)}}return e.subpaths[s]=r,r?\"real\":n?\"nested\":\"adhocOrUndefined\"}function v(t,e){return g(t,e),t.subpaths[e]}f.increment=\"`increment` should not be used as a schema path name unless you have disabled versioning.\",c.prototype.path=function(t,e){if(void 0===e)return this.paths[t]?this.paths[t]:this.subpaths[t]?this.subpaths[t]:this.singleNestedPaths[t]?this.singleNestedPaths[t]:/\\.\\d+\\.?.*$/.test(t)?v(this,t):void 0;if(d[t])throw new Error(\"`\"+t+\"` may not be used as a schema pathname\");f[t];var s=t.split(/\\./),i=s.pop(),r=this.tree;if(s.forEach(function(e,i){if(r[e]||(r[e]={}),\"object\"!=typeof r[e]){var n=\"Cannot set nested path `\"+t+\"`. Parent path `\"+s.slice(0,i).concat([e]).join(\".\")+\"` already set to type \"+r[e].name+\".\";throw new Error(n)}r=r[e]}),r[i]=n.clone(e),this.paths[t]=c.interpretAsType(t,e,this.options),this.paths[t].$isSingleNested){for(var a in this.paths[t].schema.paths)this.singleNestedPaths[t+\".\"+a]=this.paths[t].schema.paths[a];for(a in this.paths[t].schema.singleNestedPaths)this.singleNestedPaths[t+\".\"+a]=this.paths[t].schema.singleNestedPaths[a];this.childSchemas.push({schema:this.paths[t].schema,model:this.paths[t].caster})}else this.paths[t].$isMongooseDocumentArray&&this.childSchemas.push({schema:this.paths[t].schema,model:this.paths[t].casterConstructor});return this},c.interpretAsType=function(s,i,r){if(i instanceof h)return i;if(i.constructor&&\"Object\"!==n.getFunctionName(i.constructor)){var a=i;(i={})[r.typeKey]=a}var o,p=!i[r.typeKey]||\"type\"===r.typeKey&&i.type.type?{}:i[r.typeKey];if(\"Object\"===n.getFunctionName(p.constructor)||\"mixed\"===p)return new t.Mixed(s,i);if(Array.isArray(p)||Array===p||\"array\"===p){var u=Array===p||\"array\"===p?i.cast:p[0];if(u&&u.instanceOfSchema)return new t.DocumentArray(s,u,i);if(u&&u[r.typeKey]&&u[r.typeKey].instanceOfSchema)return new t.DocumentArray(s,u[r.typeKey],u);if(Array.isArray(u))return new t.Array(s,c.interpretAsType(s,u,r),i);if(\"string\"==typeof u)u=t[u.charAt(0).toUpperCase()+u.substring(1)];else if(u&&(!u[r.typeKey]||\"type\"===r.typeKey&&u.type.type)&&\"Object\"===n.getFunctionName(u.constructor)){if(Object.keys(u).length){var l={minimize:r.minimize};r.typeKey&&(l.typeKey=r.typeKey),r.hasOwnProperty(\"strict\")&&(l.strict=r.strict),r.hasOwnProperty(\"runSettersOnQuery\")&&(l.runSettersOnQuery=r.runSettersOnQuery);var d=new c(u,l);return d.$implicitlyCreated=!0,new t.DocumentArray(s,d,i)}return new t.Array(s,t.Mixed,i)}if(u&&!((o=\"string\"==typeof(p=!u[r.typeKey]||\"type\"===r.typeKey&&u.type.type?u:u[r.typeKey])?p:p.schemaName||n.getFunctionName(p))in t))throw new TypeError(\"Undefined type `\"+o+\"` at array `\"+s+\"`\");return new t.Array(s,u||t.Mixed,i,r)}if(p&&p.instanceOfSchema)return new t.Embedded(p,s,i);if((o=e.isBuffer(p)?\"Buffer\":\"string\"==typeof p?p:p.schemaName||n.getFunctionName(p))&&(o=o.charAt(0).toUpperCase()+o.substring(1)),void 0==t[o])throw new TypeError(\"Undefined type `\"+o+\"` at `\"+s+\"`\\n  Did you try nesting Schemas? You can only nest using refs or arrays.\");return\"runSettersOnQuery\"in(i=n.clone(i,{retainKeyOrder:!0}))||(i.runSettersOnQuery=r.runSettersOnQuery),new t[o](s,i)},c.prototype.eachPath=function(t){for(var e=Object.keys(this.paths),s=e.length,i=0;i<s;++i)t(e[i],this.paths[e[i]]);return this},c.prototype.requiredPaths=function(t){if(this._requiredpaths&&!t)return this._requiredpaths;for(var e=Object.keys(this.paths),s=e.length,i=[];s--;){var r=e[s];this.paths[r].isRequired&&i.push(r)}return this._requiredpaths=i,this._requiredpaths},c.prototype.indexedPaths=function(){return this._indexedpaths?this._indexedpaths:(this._indexedpaths=this.indexes(),this._indexedpaths)},c.prototype.pathType=function(t){return t in this.paths?\"real\":t in this.virtuals?\"virtual\":t in this.nested?\"nested\":t in this.subpaths?\"real\":t in this.singleNestedPaths?\"real\":/\\.\\d+\\.|\\.\\d+$/.test(t)?g(this,t):\"adhocOrUndefined\"},c.prototype.hasMixedParent=function(e){var s=e.split(/\\./g);e=\"\";for(var i=0;i<s.length;++i)if((e=i>0?e+\".\"+s[i]:s[i])in this.paths&&this.paths[e]instanceof t.Mixed)return!0;return!1},c.prototype.setupTimestamp=function(t){if(t){var e=[\"createdAt\",\"updatedAt\"].map(y.bind(null,t)),s=e[0],i=e[1],r=e.reduce(function(t,e){if(null!=e){var s=e.split(\".\");if(\"adhocOrUndefined\"===this.pathType(e))for(var i=0;i<s.length;++i)t[s[i]]=i<s.length-1?t[s[i]]||{}:Date}return t}.bind(this),{});this.add(r),this.pre(\"save\",function(t){var e=new Date,r=this._id&&this._id.auto;if(null!=s&&!this.get(s)&&this.isSelected(s)&&this.set(s,r?this._id.getTimestamp():e),null!=i&&(this.isNew||this.isModified())){var n=e;this.isNew&&(null!=s?n=this.get(s):r&&(n=this._id.getTimestamp())),this.set(i,n)}t()});var n=function(t,e){var r=new Date,n={},a=n;return e?(t&&t.$set&&(t=t.$set,n.$set={},a=n.$set),null==i||t[i]||(a[i]=r),null==s||t[s]||(a[s]=r),n):(n={$set:{}},t=t||{},null==i||t.$currentDate&&t.$currentDate[i]||(n.$set[i]=r),null!=s&&(t[s]&&delete t[s],t.$set&&t.$set[s]&&delete t.$set[s],n.$setOnInsert={},n.$setOnInsert[s]=r),n)};this.methods.initializeTimestamps=function(){return this.get(s)||this.set(s,new Date),this.get(i)||this.set(i,new Date),this},this.pre(\"findOneAndUpdate\",function(t){var e=this.options.overwrite;this.findOneAndUpdate({},n(this.getUpdate(),e),{overwrite:e}),m(this),t()}),this.pre(\"update\",function(t){var e=this.options.overwrite;this.update({},n(this.getUpdate(),e),{overwrite:e}),m(this),t()})}},c.prototype.queue=function(t,e){return this.callQueue.push([t,e]),this},c.prototype.pre=function(){var t=arguments[0];return u[t]?(this.s.hooks.pre.apply(this.s.hooks,arguments),this):this.queue(\"pre\",arguments)},c.prototype.post=function(t,e){return u[t]?(this.s.hooks.post.apply(this.s.hooks,arguments),this):e.length<2?this.queue(\"on\",[arguments[0],function(t){return e.call(t,t)}]):3===e.length?(this.s.hooks.post(t+\":error\",e),this):this.queue(\"post\",[arguments[0],function(t){var s=this,i=Array.prototype.slice.call(arguments,1);e.call(this,this,function(e){return t.apply(s,[e].concat(i))})}])},c.prototype.plugin=function(t,e){if(\"function\"!=typeof t)throw new Error('First param to `schema.plugin()` must be a function, got \"'+typeof t+'\"');if(e&&e.deduplicate)for(var s=0;s<this.plugins.length;++s)if(this.plugins[s].fn===t)return this;return this.plugins.push({fn:t,opts:e}),t(this,e),this},c.prototype.method=function(t,e){if(\"string\"!=typeof t)for(var s in t)this.methods[s]=t[s];else this.methods[t]=e;return this},c.prototype.static=function(t,e){if(\"string\"!=typeof t)for(var s in t)this.statics[s]=t[s];else this.statics[t]=e;return this},c.prototype.index=function(t,e){return e||(e={}),e.expires&&n.expires(e),this._indexes.push([t,e]),this},c.prototype.set=function(t,e,i){if(1===arguments.length)return this.options[t];switch(t){case\"read\":this.options[t]=s(e,i);break;case\"safe\":this.options[t]=!1===e?{w:0}:e;break;case\"timestamps\":this.setupTimestamp(e),this.options[t]=e;break;default:this.options[t]=e}return this},c.prototype.get=function(t){return this.options[t]};var $=\"2d 2dsphere hashed text\".split(\" \");function b(t,e){if(t.virtuals[e])return t.virtuals[e];for(var s=e.split(\".\"),i=\"\",r=\"\",n=0;n<s.length;++n)if(i+=(i.length>0?\".\":\"\")+s[n],t.virtuals[i]){if(n===s.length-1)return t.virtuals[i].$nestedSchemaPath=r,t.virtuals[i]}else{if(!t.paths[i]||!t.paths[i].schema)return null;t=t.paths[i].schema,r+=(r.length>0?\".\":\"\")+i,i=\"\"}}Object.defineProperty(c,\"indexTypes\",{get:function(){return $},set:function(){throw new Error(\"Cannot overwrite Schema.indexTypes\")}}),c.prototype.indexes=function(){\"use strict\";var e=[],s=[],i=function(r,a){if(-1===s.indexOf(r)){var o,h,p,u,l,d,f;s.push(r),a=a||\"\";for(var y=Object.keys(r.paths),m=0;m<y.length;++m)o=y[m],(h=r.paths[o])instanceof t.DocumentArray||h.$isSingleNested?!0!==h.options.excludeIndexes&&i(h.schema,a+o+\".\"):!1!==(p=h._index||h.caster&&h.caster._index)&&null!==p&&void 0!==p&&(u={},d=(l=n.isObject(p))?p:{},(f=\"string\"==typeof p?p:!!l&&p.type)&&~c.indexTypes.indexOf(f)?u[a+o]=f:d.text?(u[a+o]=\"text\",delete d.text):u[a+o]=1,delete d.type,\"background\"in d||(d.background=!0),e.push([u,d]));s.pop(),a?function(t,s){var i,r,n,a,o,h,p=t._indexes,u=p.length,c=0;for(c=0;c<u;++c){for(i=p[c][0],a=Object.keys(i),n=a.length,r={},h=0;h<n;++h)o=a[h],r[s+o]=i[o];e.push([r,p[c][1]])}}(r,a):(r._indexes.forEach(function(t){\"background\"in t[1]||(t[1].background=!0)}),e=e.concat(r._indexes))}};return i(this),e},c.prototype.virtual=function(t,e){if(e&&e.ref){if(!e.localField)throw new Error(\"Reference virtuals require `localField` option\");if(!e.foreignField)throw new Error(\"Reference virtuals require `foreignField` option\");this.pre(\"init\",function(s,i){if(p.has(t,i)){var r=p.get(t,i);this.$$populatedVirtuals||(this.$$populatedVirtuals={}),e.justOne?this.$$populatedVirtuals[t]=Array.isArray(r)?r[0]:r:this.$$populatedVirtuals[t]=Array.isArray(r)?r:null==r?[]:[r],p.unset(t,i)}if(this.ownerDocument)return s(),this;s()});var s=this.virtual(t);return s.options=e,s.get(function(){return this.$$populatedVirtuals||(this.$$populatedVirtuals={}),t in this.$$populatedVirtuals?this.$$populatedVirtuals[t]:null}).set(function(s){this.$$populatedVirtuals||(this.$$populatedVirtuals={}),e.justOne?(this.$$populatedVirtuals[t]=Array.isArray(s)?s[0]:s,\"object\"!=typeof this.$$populatedVirtuals[t]&&(this.$$populatedVirtuals[t]=null)):(this.$$populatedVirtuals[t]=Array.isArray(s)?s:null==s?[]:[s],this.$$populatedVirtuals[t]=this.$$populatedVirtuals[t].filter(function(t){return t&&\"object\"==typeof t}))})}var i=this.virtuals,n=t.split(\".\");if(\"real\"===this.pathType(t))throw new Error('Virtual path \"'+t+'\" conflicts with a real path in the schema');return i[t]=n.reduce(function(s,i,a){return s[i]||(s[i]=a===n.length-1?new r(e,t):{}),s[i]},this.tree),i[t]},c.prototype._getVirtual=function(t){return b(this,t)},c.prototype.virtualpath=function(t){return this.virtuals[t]},c.prototype.remove=function(t){\"string\"==typeof t&&(t=[t]),Array.isArray(t)&&t.forEach(function(t){if(this.path(t)){delete this.paths[t];for(var e=t.split(\".\"),s=e.pop(),i=this.tree,r=0;r<e.length;++r)i=i[e[r]];delete i[s]}},this)},c.prototype.loadClass=function(t,e){return t===Object.prototype||t===Function.prototype||t.prototype.hasOwnProperty(\"$isMongooseModelPrototype\")?this:(this.loadClass(Object.getPrototypeOf(t)),e||Object.getOwnPropertyNames(t).forEach(function(e){if(!e.match(/^(length|name|prototype)$/)){var s=Object.getOwnPropertyDescriptor(t,e);\"function\"==typeof s.value&&this.static(e,s.value)}},this),Object.getOwnPropertyNames(t.prototype).forEach(function(s){if(!s.match(/^(constructor)$/)){var i=Object.getOwnPropertyDescriptor(t.prototype,s);e||\"function\"==typeof i.value&&this.method(s,i.value),\"function\"==typeof i.get&&this.virtual(s).get(i.get),\"function\"==typeof i.set&&this.virtual(s).set(i.set)}},this),this)},c.prototype._getSchema=function(e){var s=this.path(e),i=[];if(s)return s.$fullPath=e,s;for(var r=e.split(\".\"),n=0;n<r.length;++n)\"$\"===r[n]&&(r[n]=\"0\");return function e(s,r){for(var n,a,o=s.length+1;o--;)if(a=s.slice(0,o).join(\".\"),n=r.path(a)){if(i.push(a),n.caster){if(n.caster instanceof t.Mixed)return n.caster.$fullPath=i.join(\".\"),n.caster;var h;if(o!==s.length&&n.schema)return\"$\"===s[o]?o+1===s.length?n:((h=e(s.slice(o+1),n.schema))&&(h.$isUnderneathDocArray=h.$isUnderneathDocArray||!n.schema.$isSingleNested),h):((h=e(s.slice(o),n.schema))&&(h.$isUnderneathDocArray=h.$isUnderneathDocArray||!n.schema.$isSingleNested),h)}return n.$fullPath=i.join(\".\"),n}}(r,this)},c.prototype._getPathType=function(e){if(this.path(e))return\"real\";return function e(s,i){for(var r,n,a=s.length+1;a--;){if(n=s.slice(0,a).join(\".\"),r=i.path(n))return r.caster?r.caster instanceof t.Mixed?{schema:r,pathType:\"mixed\"}:a!==s.length&&r.schema?\"$\"===s[a]?a===s.length-1?{schema:r,pathType:\"nested\"}:e(s.slice(a+1),r.schema):e(s.slice(a),r.schema):{schema:r,pathType:r.$isSingleNested?\"nested\":\"array\"}:{schema:r,pathType:\"real\"};if(a===s.length&&i.nested[n])return{schema:i,pathType:\"nested\"}}return{schema:r||i,pathType:\"undefined\"}}(e.split(\".\"),this)},module.exports=exports=c,c.Types=t=require(\"./schema/index\"),exports.ObjectId=t.ObjectId;"},"hash":"422a03732fa58a74dd62dde0f3dd00ba"}